<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Fields</title>
  <link rel="stylesheet" th:href="@{/css/bootstrap.min.css}">
  <link rel="stylesheet" th:href="@{/css/styles.css}">
  <script th:src="@{/js/bootstrap.bundle.min.js}"></script>
</head>
<body>
<div th:if="${errorMessage}"
     class="alert alert-danger alert-dismissable fade show" role="alert">
  <span th:text="${errorMessage}"></span>
  <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Закрыть"></button>
</div>
<div th:replace="~{fragments/layout :: app-nav}"></div>
<div class="container mt-4">
  <div class="d-flex justify-content-between align-items-center mb-4">
    <h1 class="h3">Настроить поля</h1>
    <div th:replace="~{fragments/modals :: create-field-modal}"></div>
    <button class="btn btn-primary" type="submit" formmethod="post" form="fields-form">Сохранить</button>
  </div>
  <form method="get" action="#" id="fields-form">
    <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
    <div class="table-responsive">
      <table class="table table-striped table-hover align-middle table-fixed">
        <thead>
        <tr>
          <th style="width: 20%">Имя</th>
          <th style="width: 50%">Тип поля</th>
          <th style="width: 55%">Возможные значения</th>
          <th style="width: 5%"></th>
        </tr>
        </thead>
        <tbody>
        <tr th:each="field : ${fields}">
          <td>
            <input type="hidden" th:name="fieldIds[]" th:value="${field.id}" />
            <input class="form-control"
                   type="text" name="names[]"
                   th:value="${field.name}">
          </td>
          <td>
            <select class="form-select"
                    name="types[]">
              <option value="TEXT" th:selected="${field.type.name() == 'TEXT'}">
                Текст
              </option>
              <option value="NUMBER" th:selected="${field.type.name() == 'NUMBER'}">
                Число
              </option>
              <option value="BOOLEAN" th:selected="${field.type.name() == 'BOOLEAN'}">
                Да/нет
              </option>
              <option value="DATE" th:selected="${field.type.name() == 'DATE'}">
                Дата
              </option>
              <option value="ENUM" th:selected="${field.type.name() == 'ENUM'}">
                Выбор
              </option>
            </select>
          </td>
          <td>
            <input th:if="${field.type.name() == 'ENUM'}"
                   class="form-control" type="text"
                   name="validValues[]" th:value="${#strings.listJoin(field.validValues, ', ')}">
            <input th:if="${field.type.name() != 'ENUM'}"
                   class="form-control" type="hidden"
                   name="validValues[]" th:value="null">
          </td>
          <td>
            <!-- change to opening a delete confirmation modal -->
            <form action="" method="get">
              <div th:replace="~{fragments/modals :: confirm-delete-modal('/fields/' + ${field.id}, false, ${field.id})}"></div>
            </form>
          </td>
        </tr>
        </tbody>
      </table>
    </div>
  </form>
</div>
<script>
  document.addEventListener("DOMContentLoaded", () => {
    let selects = document.querySelectorAll("[name='types[]']")
    selects.forEach(el => {
      el.addEventListener("change", e => {
        let row = e.target.closest("tr")
        let validValuesInput = row.querySelector("[name='validValues[]']")
        if (e.target.value == "ENUM") {
          validValuesInput.type = "text"
        } else {
          validValuesInput.type = "hidden"
          validValuesInput.value = ""
        }
      })
    })
  })
</script>
</body>
</html>